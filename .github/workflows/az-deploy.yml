name: az-deploy
on:
  push:
    branches:
      - 'main'

# see: https://tomgregory.com/build-gradle-projects-with-github-actions/#:~:text=If%20you%20have%20a%20Gradle,entirely%20hosted%20on%20their%20infrastructure

jobs:

  az-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: checkout sources
        uses: actions/checkout@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: 17
          distribution: 'adopt'
          cache: gradle

        #
        # this creates the docker images we need for the services
      - name: Run gradle jib to create and push the image to ttl
        run: ./gradlew jib --no-daemon

        #
        # setup the k8s access
        #
        # k8s-url:     kubectl config view --minify -o 'jsonpath={.clusters[0].cluster.server}'
        # k8s-secret:  kubectl get serviceAccounts <service-account-name> -n <namespace> -o 'jsonpath={.secrets[*].name}'
        #
        #
      - name: Setup k8s namespace
        uses: azure/k8s-set-context@v1
        with:
          method: service-account
          k8s-url: https://charonclus-charonresourcegr-af0e33-d2cf865c.hcp.germanywestcentral.azmk8s.io:443
          k8s-secret: <secret associated with the service account>

      - name: Deploy the image
        uses: Azure/k8s-deploy@v1
        with:
          manifests: |
            manifests/deployment.yaml
            manifests/service.yaml
          images: |
            cloudlifeacr.azurecr.io/k8sflask:${{ github.sha }}
