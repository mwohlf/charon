name: az-deploy
on:
  push:
    branches:
      - 'main'


jobs:

  az-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: checkout sources
        uses: actions/checkout@v2

      - name: Set up JDK 17
        uses: actions/setup-java@v2
        with:
          java-version: 17
          distribution: 'adopt'
          cache: gradle

      #
      # this creates the docker images we need for the services
      - name: Run gradle jib to create and push the image to ttl
        run: ${{ github.workspace }}/gradlew jib --no-daemon

      # set and authorize to the target Azure Kubernetes Service (AKS) cluster.
      - name: Setup Azure Context
        # env:
        #  SERVICE_PRINCIPAL: ${{ secrets.AZURE_SP_CREDENTIALS }}
        uses: azure/aks-set-context@v1
        with:
          # set in GitHub -> Repo -> Secrets -> Actions -> New Repository secret -> insert Name, Value
          creds: ${{ secrets.AZURE_SP_CREDENTIALS }}
          cluster-name: charonCluster
          resource-group: charonResourceGroup
          # results in a "KUBECONFIG environment variable is set"

      - name: Process helm chart # we can also use compose here: https://github.com/Azure/k8s-bake
        id: bake  # gives us ${{ steps.bake.outputs.manifestsBundle }}
        uses: azure/k8s-bake@v1
        with:
          renderEngine: 'helm'
          helmChart: ${{ github.workspace }}/etc/helm/charon/
          overrides: image.tag:hello-world
          # overrides: image.tag:ttl.sh/charon-backend-${{ github.sha }}:1h
          helm-version: 'latest'

      # see: https://blog.baeke.info/2021/01/11/kubernetes-canary-deployments-with-github-actions/
      - name: Deploy the image setup as helm chart
        uses: Azure/k8s-deploy@v1
        timeout-minutes: 5
        with:
          manifests: ${{ steps.bake.outputs.manifestsBundle }}
          kubectl-version: 'latest'
